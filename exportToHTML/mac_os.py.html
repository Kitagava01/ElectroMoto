<html>
<head>
<title>mac_os.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
mac_os.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;The Apple Framework builds require their own customization.&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">struct</span>
<span class="s2">import </span><span class="s1">subprocess</span>
<span class="s2">from </span><span class="s1">abc </span><span class="s2">import </span><span class="s1">ABC</span><span class="s3">, </span><span class="s1">abstractmethod</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">from </span><span class="s1">textwrap </span><span class="s2">import </span><span class="s1">dedent</span>

<span class="s2">from </span><span class="s1">virtualenv</span><span class="s3">.</span><span class="s1">create</span><span class="s3">.</span><span class="s1">via_global_ref</span><span class="s3">.</span><span class="s1">builtin</span><span class="s3">.</span><span class="s1">ref </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ExePathRefToDest</span><span class="s3">,</span>
    <span class="s1">PathRefToDest</span><span class="s3">,</span>
    <span class="s1">RefMust</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">virtualenv</span><span class="s3">.</span><span class="s1">create</span><span class="s3">.</span><span class="s1">via_global_ref</span><span class="s3">.</span><span class="s1">builtin</span><span class="s3">.</span><span class="s1">via_global_self_do </span><span class="s2">import </span><span class="s1">BuiltinViaGlobalRefMeta</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">common </span><span class="s2">import </span><span class="s1">CPython</span><span class="s3">, </span><span class="s1">CPythonPosix</span><span class="s3">, </span><span class="s1">is_mac_os_framework</span><span class="s3">, </span><span class="s1">is_macos_brew</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">cpython3 </span><span class="s2">import </span><span class="s1">CPython3</span>


<span class="s2">class </span><span class="s1">CPythonmacOsFramework</span><span class="s3">(</span><span class="s1">CPython</span><span class="s3">, </span><span class="s1">ABC</span><span class="s3">):</span>
    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">can_describe</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">interpreter</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">is_mac_os_framework</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">) </span><span class="s2">and </span><span class="s1">super</span><span class="s3">().</span><span class="s1">can_describe</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">create</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">create</span><span class="s3">()</span>

        <span class="s4"># change the install_name of the copied python executables</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">desired_mach_o_image_path</span><span class="s3">()</span>
        <span class="s1">current </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">current_mach_o_image_path</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">src </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_sources</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">ExePathRefToDest</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span><span class="s1">src</span><span class="s3">.</span><span class="s1">must </span><span class="s3">== </span><span class="s1">RefMust</span><span class="s3">.</span><span class="s1">COPY </span><span class="s2">or not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">symlinks</span><span class="s3">):</span>
                <span class="s1">exes </span><span class="s3">= [</span><span class="s1">self</span><span class="s3">.</span><span class="s1">bin_dir </span><span class="s3">/ </span><span class="s1">src</span><span class="s3">.</span><span class="s1">base</span><span class="s3">]</span>
                <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">symlinks</span><span class="s3">:</span>
                    <span class="s1">exes</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">bin_dir </span><span class="s3">/ </span><span class="s1">a </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">src</span><span class="s3">.</span><span class="s1">aliases</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">exe </span><span class="s2">in </span><span class="s1">exes</span><span class="s3">:</span>
                    <span class="s1">fix_mach_o</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">exe</span><span class="s3">), </span><span class="s1">current</span><span class="s3">, </span><span class="s1">target</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">interpreter</span><span class="s3">.</span><span class="s1">max_size</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">_executables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">interpreter</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">_</span><span class="s3">, </span><span class="s1">targets</span><span class="s3">, </span><span class="s1">must</span><span class="s3">, </span><span class="s1">when </span><span class="s2">in </span><span class="s1">super</span><span class="s3">().</span><span class="s1">_executables</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">):</span>
            <span class="s4"># Make sure we use the embedded interpreter inside the framework, even if sys.executable points to the</span>
            <span class="s4"># stub executable in ${sys.prefix}/bin.</span>
            <span class="s4"># See http://groups.google.com/group/python-virtualenv/browse_thread/thread/17cab2f85da75951</span>
            <span class="s1">fixed_host_exe </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">.</span><span class="s1">prefix</span><span class="s3">) / </span><span class="s5">&quot;Resources&quot; </span><span class="s3">/ </span><span class="s5">&quot;Python.app&quot; </span><span class="s3">/ </span><span class="s5">&quot;Contents&quot; </span><span class="s3">/ </span><span class="s5">&quot;MacOS&quot; </span><span class="s3">/ </span><span class="s5">&quot;Python&quot;</span>
            <span class="s2">yield </span><span class="s1">fixed_host_exe</span><span class="s3">, </span><span class="s1">targets</span><span class="s3">, </span><span class="s1">must</span><span class="s3">, </span><span class="s1">when</span>

    <span class="s3">@</span><span class="s1">abstractmethod</span>
    <span class="s2">def </span><span class="s1">current_mach_o_image_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s3">@</span><span class="s1">abstractmethod</span>
    <span class="s2">def </span><span class="s1">desired_mach_o_image_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>


<span class="s2">class </span><span class="s1">CPython3macOsFramework</span><span class="s3">(</span><span class="s1">CPythonmacOsFramework</span><span class="s3">, </span><span class="s1">CPython3</span><span class="s3">, </span><span class="s1">CPythonPosix</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">current_mach_o_image_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">&quot;@executable_path/../../../../Python3&quot;</span>

    <span class="s2">def </span><span class="s1">desired_mach_o_image_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">&quot;@executable_path/../.Python&quot;</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">sources</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">interpreter</span><span class="s3">):</span>
        <span class="s2">yield from </span><span class="s1">super</span><span class="s3">().</span><span class="s1">sources</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">)</span>

        <span class="s4"># add a symlink to the host python image</span>
        <span class="s1">exe </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">.</span><span class="s1">prefix</span><span class="s3">) / </span><span class="s5">&quot;Python3&quot;</span>
        <span class="s2">yield </span><span class="s1">PathRefToDest</span><span class="s3">(</span><span class="s1">exe</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">self</span><span class="s3">, </span><span class="s1">_</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dest </span><span class="s3">/ </span><span class="s5">&quot;.Python&quot;</span><span class="s3">, </span><span class="s1">must</span><span class="s3">=</span><span class="s1">RefMust</span><span class="s3">.</span><span class="s1">SYMLINK</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">reload_code</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">super</span><span class="s3">().</span><span class="s1">reload_code</span>
        <span class="s2">return </span><span class="s1">dedent</span><span class="s3">(</span>
            <span class="s5">f&quot;&quot;&quot;</span>
        <span class="s5"># the bundled site.py always adds the global site package if we're on python framework build, escape this</span>
        <span class="s5">import sys</span>
        <span class="s5">before = sys._framework</span>
        <span class="s5">try:</span>
            <span class="s5">sys._framework = None</span>
            <span class="s2">{</span><span class="s1">result</span><span class="s2">}</span>
        <span class="s5">finally:</span>
            <span class="s5">sys._framework = before</span>
        <span class="s5">&quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">fix_mach_o</span><span class="s3">(</span><span class="s1">exe</span><span class="s3">, </span><span class="s1">current</span><span class="s3">, </span><span class="s1">new</span><span class="s3">, </span><span class="s1">max_size</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    https://en.wikipedia.org/wiki/Mach-O. 
 
    Mach-O, short for Mach object file format, is a file format for executables, object code, shared libraries, 
    dynamically-loaded code, and core dumps. A replacement for the a.out format, Mach-O offers more extensibility and 
    faster access to information in the symbol table. 
 
    Each Mach-O file is made up of one Mach-O header, followed by a series of load commands, followed by one or more 
    segments, each of which contains between 0 and 255 sections. Mach-O uses the REL relocation format to handle 
    references to symbols. When looking up symbols Mach-O uses a two-level namespace that encodes each symbol into an 
    'object/symbol name' pair that is then linearly searched for by first the object and then the symbol name. 
 
    The basic structure—a list of variable-length &quot;load commands&quot; that reference pages of data elsewhere in the file—was 
    also used in the executable file format for Accent. The Accent file format was in turn, based on an idea from Spice 
    Lisp. 
 
    With the introduction of Mac OS X 10.6 platform the Mach-O file underwent a significant modification that causes 
    binaries compiled on a computer running 10.6 or later to be (by default) executable only on computers running Mac 
    OS X 10.6 or later. The difference stems from load commands that the dynamic linker, in previous Mac OS X versions, 
    does not understand. Another significant change to the Mach-O format is the change in how the Link Edit tables 
    (found in the __LINKEDIT section) function. In 10.6 these new Link Edit tables are compressed by removing unused and 
    unneeded bits of information, however Mac OS X 10.5 and earlier cannot read this new Link Edit table format. 
    &quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">logging</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;change Mach-O for %s from %s to %s&quot;</span><span class="s3">, </span><span class="s1">exe</span><span class="s3">, </span><span class="s1">current</span><span class="s3">, </span><span class="s1">new</span><span class="s3">)</span>
        <span class="s1">_builtin_change_mach_o</span><span class="s3">(</span><span class="s1">max_size</span><span class="s3">)(</span><span class="s1">exe</span><span class="s3">, </span><span class="s1">current</span><span class="s3">, </span><span class="s1">new</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:  </span><span class="s4"># noqa: BLE001</span>
        <span class="s1">logging</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span><span class="s5">&quot;Could not call _builtin_change_mac_o: %s. Trying to call install_name_tool instead.&quot;</span><span class="s3">, </span><span class="s1">e</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">cmd </span><span class="s3">= [</span><span class="s5">&quot;install_name_tool&quot;</span><span class="s3">, </span><span class="s5">&quot;-change&quot;</span><span class="s3">, </span><span class="s1">current</span><span class="s3">, </span><span class="s1">new</span><span class="s3">, </span><span class="s1">exe</span><span class="s3">]</span>
            <span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_call</span><span class="s3">(</span><span class="s1">cmd</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s1">logging</span><span class="s3">.</span><span class="s1">fatal</span><span class="s3">(</span><span class="s5">&quot;Could not call install_name_tool -- you must have Apple's development tools installed&quot;</span><span class="s3">)</span>
            <span class="s2">raise</span>


<span class="s2">def </span><span class="s1">_builtin_change_mach_o</span><span class="s3">(</span><span class="s1">maxint</span><span class="s3">):  </span><span class="s4"># noqa: C901</span>
    <span class="s1">MH_MAGIC </span><span class="s3">= </span><span class="s6">0xFEEDFACE  </span><span class="s4"># noqa: N806</span>
    <span class="s1">MH_CIGAM </span><span class="s3">= </span><span class="s6">0xCEFAEDFE  </span><span class="s4"># noqa: N806</span>
    <span class="s1">MH_MAGIC_64 </span><span class="s3">= </span><span class="s6">0xFEEDFACF  </span><span class="s4"># noqa: N806</span>
    <span class="s1">MH_CIGAM_64 </span><span class="s3">= </span><span class="s6">0xCFFAEDFE  </span><span class="s4"># noqa: N806</span>
    <span class="s1">FAT_MAGIC </span><span class="s3">= </span><span class="s6">0xCAFEBABE  </span><span class="s4"># noqa: N806</span>
    <span class="s1">BIG_ENDIAN </span><span class="s3">= </span><span class="s5">&quot;&gt;&quot;  </span><span class="s4"># noqa: N806</span>
    <span class="s1">LITTLE_ENDIAN </span><span class="s3">= </span><span class="s5">&quot;&lt;&quot;  </span><span class="s4"># noqa: N806</span>
    <span class="s1">LC_LOAD_DYLIB </span><span class="s3">= </span><span class="s6">0xC  </span><span class="s4"># noqa: N806</span>

    <span class="s2">class </span><span class="s1">FileView</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;A proxy for file-like objects that exposes a given view of a file. Modified from macholib.&quot;&quot;&quot;</span>

        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file_obj</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">maxint</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">file_obj</span><span class="s3">, </span><span class="s1">FileView</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj </span><span class="s3">= </span><span class="s1">file_obj</span><span class="s3">.</span><span class="s1">_file_obj  </span><span class="s4"># noqa: SLF001</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj </span><span class="s3">= </span><span class="s1">file_obj</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_start </span><span class="s3">= </span><span class="s1">start</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_end </span><span class="s3">= </span><span class="s1">start </span><span class="s3">+ </span><span class="s1">size</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_pos </span><span class="s3">= </span><span class="s6">0</span>

        <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">f&quot;&lt;fileview [</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start</span><span class="s2">:</span><span class="s5">d</span><span class="s2">}</span><span class="s5">, </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_end</span><span class="s2">:</span><span class="s5">d</span><span class="s2">}</span><span class="s5">] </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj</span><span class="s2">!r}</span><span class="s5">&gt;&quot;</span>

        <span class="s2">def </span><span class="s1">tell</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pos</span>

        <span class="s2">def </span><span class="s1">_checkwindow</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">seek_to</span><span class="s3">, </span><span class="s1">op</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start </span><span class="s3">&lt;= </span><span class="s1">seek_to </span><span class="s3">&lt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_end</span><span class="s3">):</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">op</span><span class="s2">} </span><span class="s5">to offset </span><span class="s2">{</span><span class="s1">seek_to</span><span class="s2">:</span><span class="s5">d</span><span class="s2">} </span><span class="s5">is outside window [</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start</span><span class="s2">:</span><span class="s5">d</span><span class="s2">}</span><span class="s5">, </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_end</span><span class="s2">:</span><span class="s5">d</span><span class="s2">}</span><span class="s5">]&quot;</span>
                <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">seek</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">whence</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
            <span class="s1">seek_to </span><span class="s3">= </span><span class="s1">offset</span>
            <span class="s2">if </span><span class="s1">whence </span><span class="s3">== </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_SET</span><span class="s3">:</span>
                <span class="s1">seek_to </span><span class="s3">+= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start</span>
            <span class="s2">elif </span><span class="s1">whence </span><span class="s3">== </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_CUR</span><span class="s3">:</span>
                <span class="s1">seek_to </span><span class="s3">+= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pos</span>
            <span class="s2">elif </span><span class="s1">whence </span><span class="s3">== </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_END</span><span class="s3">:</span>
                <span class="s1">seek_to </span><span class="s3">+= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_end</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;Invalid whence argument to seek: </span><span class="s2">{</span><span class="s1">whence</span><span class="s2">!r}</span><span class="s5">&quot;</span>
                <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkwindow</span><span class="s3">(</span><span class="s1">seek_to</span><span class="s3">, </span><span class="s5">&quot;seek&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">seek_to</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_pos </span><span class="s3">= </span><span class="s1">seek_to </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start</span>

        <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">content</span><span class="s3">):</span>
            <span class="s1">here </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pos</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkwindow</span><span class="s3">(</span><span class="s1">here</span><span class="s3">, </span><span class="s5">&quot;write&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkwindow</span><span class="s3">(</span><span class="s1">here </span><span class="s3">+ </span><span class="s1">len</span><span class="s3">(</span><span class="s1">content</span><span class="s3">), </span><span class="s5">&quot;write&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">here</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_SET</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">content</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_pos </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">content</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">maxint</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">size </span><span class="s3">&gt;= </span><span class="s6">0  </span><span class="s4"># noqa: S101</span>
            <span class="s1">here </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_start </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pos</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkwindow</span><span class="s3">(</span><span class="s1">here</span><span class="s3">, </span><span class="s5">&quot;read&quot;</span><span class="s3">)</span>
            <span class="s1">size </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">size</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_end </span><span class="s3">- </span><span class="s1">here</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">here</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_SET</span><span class="s3">)</span>
            <span class="s1">read_bytes </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_file_obj</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">size</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_pos </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">read_bytes</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">read_bytes</span>

    <span class="s2">def </span><span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Read a given number of 32-bits unsigned integers from the given file with the given endianness.&quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s1">endian </span><span class="s3">+ </span><span class="s5">&quot;L&quot; </span><span class="s3">* </span><span class="s1">num</span><span class="s3">, </span><span class="s1">file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">num </span><span class="s3">* </span><span class="s6">4</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">res</span><span class="s3">) == </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">res</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">mach_o_change</span><span class="s3">(</span><span class="s1">at_path</span><span class="s3">, </span><span class="s1">what</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):  </span><span class="s4"># noqa: C901</span>
        <span class="s5">&quot;&quot;&quot; 
        Replace a given name (what) in any LC_LOAD_DYLIB command found in the given binary with a new name (value), 
        provided it's shorter. 
        &quot;&quot;&quot;  </span><span class="s4"># noqa: D205</span>

        <span class="s2">def </span><span class="s1">do_macho</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">bits</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">):</span>
            <span class="s4"># Read Mach-O header (the magic number is assumed read by the caller)</span>
            <span class="s1">_cpu_type</span><span class="s3">, </span><span class="s1">_cpu_sub_type</span><span class="s3">, </span><span class="s1">_file_type</span><span class="s3">, </span><span class="s1">n_commands</span><span class="s3">, </span><span class="s1">_size_of_commands</span><span class="s3">, </span><span class="s1">_flags </span><span class="s3">= </span><span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">, </span><span class="s6">6</span><span class="s3">)</span>
            <span class="s4"># 64-bits header has one more field.</span>
            <span class="s2">if </span><span class="s1">bits </span><span class="s3">== </span><span class="s6">64</span><span class="s3">:  </span><span class="s4"># noqa: PLR2004</span>
                <span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">)</span>
            <span class="s4"># The header is followed by n commands</span>
            <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n_commands</span><span class="s3">):</span>
                <span class="s1">where </span><span class="s3">= </span><span class="s1">file</span><span class="s3">.</span><span class="s1">tell</span><span class="s3">()</span>
                <span class="s4"># Read command header</span>
                <span class="s1">cmd</span><span class="s3">, </span><span class="s1">cmd_size </span><span class="s3">= </span><span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">cmd </span><span class="s3">== </span><span class="s1">LC_LOAD_DYLIB</span><span class="s3">:</span>
                    <span class="s4"># The first data field in LC_LOAD_DYLIB commands is the offset of the name, starting from the</span>
                    <span class="s4"># beginning of the  command.</span>
                    <span class="s1">name_offset </span><span class="s3">= </span><span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">endian</span><span class="s3">)</span>
                    <span class="s1">file</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">where </span><span class="s3">+ </span><span class="s1">name_offset</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_SET</span><span class="s3">)</span>
                    <span class="s4"># Read the NUL terminated string</span>
                    <span class="s1">load </span><span class="s3">= </span><span class="s1">file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">cmd_size </span><span class="s3">- </span><span class="s1">name_offset</span><span class="s3">).</span><span class="s1">decode</span><span class="s3">()</span>
                    <span class="s1">load </span><span class="s3">= </span><span class="s1">load</span><span class="s3">[: </span><span class="s1">load</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\0</span><span class="s5">&quot;</span><span class="s3">)]</span>
                    <span class="s4"># If the string is what is being replaced, overwrite it.</span>
                    <span class="s2">if </span><span class="s1">load </span><span class="s3">== </span><span class="s1">what</span><span class="s3">:</span>
                        <span class="s1">file</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">where </span><span class="s3">+ </span><span class="s1">name_offset</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_SET</span><span class="s3">)</span>
                        <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">value</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">() + </span><span class="s7">b&quot;</span><span class="s2">\0</span><span class="s7">&quot;</span><span class="s3">)</span>
                <span class="s4"># Seek to the next command</span>
                <span class="s1">file</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">where </span><span class="s3">+ </span><span class="s1">cmd_size</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_SET</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">do_file</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">maxint</span><span class="s3">):</span>
            <span class="s1">file </span><span class="s3">= </span><span class="s1">FileView</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>
            <span class="s4"># Read magic number</span>
            <span class="s1">magic </span><span class="s3">= </span><span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">BIG_ENDIAN</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">magic </span><span class="s3">== </span><span class="s1">FAT_MAGIC</span><span class="s3">:</span>
                <span class="s4"># Fat binaries contain nfat_arch Mach-O binaries</span>
                <span class="s1">n_fat_arch </span><span class="s3">= </span><span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">BIG_ENDIAN</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n_fat_arch</span><span class="s3">):</span>
                    <span class="s4"># Read arch header</span>
                    <span class="s1">_cpu_type</span><span class="s3">, </span><span class="s1">_cpu_sub_type</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">_align </span><span class="s3">= </span><span class="s1">read_data</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">BIG_ENDIAN</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)</span>
                    <span class="s1">do_file</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">magic </span><span class="s3">== </span><span class="s1">MH_MAGIC</span><span class="s3">:</span>
                <span class="s1">do_macho</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s6">32</span><span class="s3">, </span><span class="s1">BIG_ENDIAN</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">magic </span><span class="s3">== </span><span class="s1">MH_CIGAM</span><span class="s3">:</span>
                <span class="s1">do_macho</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s6">32</span><span class="s3">, </span><span class="s1">LITTLE_ENDIAN</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">magic </span><span class="s3">== </span><span class="s1">MH_MAGIC_64</span><span class="s3">:</span>
                <span class="s1">do_macho</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s6">64</span><span class="s3">, </span><span class="s1">BIG_ENDIAN</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">magic </span><span class="s3">== </span><span class="s1">MH_CIGAM_64</span><span class="s3">:</span>
                <span class="s1">do_macho</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s6">64</span><span class="s3">, </span><span class="s1">LITTLE_ENDIAN</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">what</span><span class="s3">) &gt;= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)  </span><span class="s4"># noqa: S101</span>

        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">at_path</span><span class="s3">, </span><span class="s5">&quot;r+b&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">do_file</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">mach_o_change</span>


<span class="s2">class </span><span class="s1">CPython3macOsBrew</span><span class="s3">(</span><span class="s1">CPython3</span><span class="s3">, </span><span class="s1">CPythonPosix</span><span class="s3">):</span>
    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">can_describe</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">interpreter</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">is_macos_brew</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">) </span><span class="s2">and </span><span class="s1">super</span><span class="s3">().</span><span class="s1">can_describe</span><span class="s3">(</span><span class="s1">interpreter</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_meta</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">interpreter</span><span class="s3">):  </span><span class="s4"># noqa: ARG003</span>
        <span class="s1">meta </span><span class="s3">= </span><span class="s1">BuiltinViaGlobalRefMeta</span><span class="s3">()</span>
        <span class="s1">meta</span><span class="s3">.</span><span class="s1">copy_error </span><span class="s3">= </span><span class="s5">&quot;Brew disables copy creation: https://github.com/Homebrew/homebrew-core/issues/138159&quot;</span>
        <span class="s2">return </span><span class="s1">meta</span>


<span class="s1">__all__ </span><span class="s3">= [</span>
    <span class="s5">&quot;CPython3macOsBrew&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;CPython3macOsFramework&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;CPythonmacOsFramework&quot;</span><span class="s3">,</span>
<span class="s3">]</span>
</pre>
</body>
</html>